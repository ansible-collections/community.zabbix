---
# task file for mysql
- name: "Install MySQL dependencies"
  when: zabbix_proxy_database_creation or zabbix_proxy_database_sqlload
  ansible.builtin.package:
    name: "{{ _zabbix_proxy_mysql_dependencies[ ansible_facts['distribution_major_version'] ] | select | list }}"
  environment:
    http_proxy: "{{ zabbix_http_proxy | default(None) | default(omit) }}"
    https_proxy: "{{ zabbix_https_proxy | default(None) | default(omit) }}"
  become: true
  register: _zabbix_proxy_dependencies_installed
  until: _zabbix_proxy_dependencies_installed is succeeded
  tags:
    - install
    - database
    - dependencies

# NOTE: Upgrading system-packages with pip is generally a bad idea, but
# these packaged older versions seems to have a problem with mysql 8 and above
- name: Upgrade pymysql
  when:
    - ansible_facts['distribution'] in ['CentOS', 'Debian', 'Ubuntu']
    - ansible_facts['distribution_release'] in ['Core', 'buster', 'bullseye', 'bionic', 'focal']
  ansible.builtin.pip:
    name: "pymysql>=0.10.0,<0.11.0"
    state: latest

- name: "MySQL Database prep"
  when: zabbix_proxy_database_creation
  delegate_to: "{{ zabbix_proxy_real_dbhost | default(zabbix_proxy_dbhost_run_install | ternary(delegated_dbhost, inventory_hostname)) }}"
  vars:
    delegated_dbhost: "{{ (zabbix_proxy_dbhost == 'localhost') | ternary(inventory_hostname, zabbix_proxy_dbhost) }}"
  tags:
    - database
    - skip_ansible_lint
  block:
    - name: "MySQL | Create database"
      community.mysql.mysql_db:
        login_user: "{{ zabbix_proxy_mysql_login_user | default(omit) }}"
        login_password: "{{ zabbix_proxy_mysql_login_password | default(omit) }}"
        login_host: "{{ zabbix_proxy_mysql_login_host | default(omit) }}"
        login_port: "{{ zabbix_proxy_mysql_login_port | default(omit) }}"
        login_unix_socket: "{{ zabbix_proxy_mysql_login_unix_socket | default(omit) }}"
        name: "{{ zabbix_proxy_dbname }}"
        encoding: "{{ zabbix_proxy_dbencoding }}"
        collation: "{{ zabbix_proxy_dbcollation }}"
        state: present
      register: zabbix_database_created

    - name: "MySQL | Create database user"
      community.mysql.mysql_user:
        login_user: "{{ zabbix_proxy_mysql_login_user | default(omit) }}"
        login_password: "{{ zabbix_proxy_mysql_login_password | default(omit) }}"
        login_host: "{{ zabbix_proxy_mysql_login_host | default(omit) }}"
        login_port: "{{ zabbix_proxy_mysql_login_port | default(omit) }}"
        login_unix_socket: "{{ zabbix_proxy_mysql_login_unix_socket | default(omit) }}"
        name: "{{ zabbix_proxy_dbuser }}"
        password: "{{ zabbix_proxy_dbpassword }}"
        priv: "{{ zabbix_proxy_dbname }}.*:ALL"
        host: "{{ zabbix_proxy_privileged_host }}"
        plugin: "{{ 'mysql_native_password' if (ansible_os_family == 'RedHat' and ansible_distribution_major_version == '7') else omit }}"
        state: present

- name: "MySQL | Check if we have done files"
  ansible.builtin.stat:
    path: /etc/zabbix/schema.done
  register: done_file
  become: true
  when:
    - zabbix_proxy_database_sqlload
  tags:
    - database

- name: "MySQL | Get version_comment"
  community.mysql.mysql_variables:
    variable: version
    login_host: "{{ zabbix_proxy_mysql_login_host | default(omit) }}"
    login_user: "{{ zabbix_proxy_mysql_login_user | default(omit) }}"
    login_password: "{{ zabbix_proxy_mysql_login_password | default(omit) }}"
    login_port: "{{ zabbix_proxy_mysql_login_port | default(omit) }}"
    login_unix_socket: "{{ zabbix_proxy_mysql_login_unix_socket | default(omit) }}"
  delegate_to: "{{ zabbix_proxy_real_dbhost | default(zabbix_proxy_dbhost_run_install | ternary(delegated_dbhost, inventory_hostname)) }}"
  vars:
    delegated_dbhost: "{{ (zabbix_proxy_dbhost == 'localhost') | ternary(inventory_hostname, zabbix_proxy_dbhost) }}"
  register: install_mysql_version
  tags:
    - database

- name: "MySQL | Get current value for innodb_default_row_format"
  community.mysql.mysql_variables:
    variable: innodb_default_row_format
    login_host: "{{ zabbix_proxy_mysql_login_host | default(omit) }}"
    login_user: "{{ zabbix_proxy_mysql_login_user | default(omit) }}"
    login_password: "{{ zabbix_proxy_mysql_login_password | default(omit) }}"
    login_port: "{{ zabbix_proxy_mysql_login_port | default(omit) }}"
    login_unix_socket: "{{ zabbix_proxy_mysql_login_unix_socket | default(omit) }}"
  delegate_to: "{{ zabbix_proxy_real_dbhost | default(zabbix_proxy_dbhost_run_install | ternary(delegated_dbhost, inventory_hostname)) }}"
  vars:
    delegated_dbhost: "{{ (zabbix_proxy_dbhost == 'localhost') | ternary(inventory_hostname, zabbix_proxy_dbhost) }}"
  register: mysql_innodb_default_row_format
  when:
    - install_mysql_version.msg is version('5.6', '>=')
  tags:
    - database

- name: "MySQL | Set innodb_default_row_format to dynamic"
  community.mysql.mysql_variables:
    variable: innodb_default_row_format
    value: dynamic
    login_host: "{{ zabbix_proxy_mysql_login_host | default(omit) }}"
    login_user: "{{ zabbix_proxy_mysql_login_user | default(omit) }}"
    login_password: "{{ zabbix_proxy_mysql_login_password | default(omit) }}"
    login_port: "{{ zabbix_proxy_mysql_login_port | default(omit) }}"
    login_unix_socket: "{{ zabbix_proxy_mysql_login_unix_socket | default(omit) }}"
  when:
    - zabbix_proxy_database_sqlload | bool
    - not done_file.stat.exists
    - install_mysql_version.msg is version('5.6', '>=')
    - mysql_innodb_default_row_format.msg != 'dynamic'
  delegate_to: "{{ zabbix_proxy_real_dbhost | default(zabbix_proxy_dbhost_run_install | ternary(delegated_dbhost, inventory_hostname)) }}"
  vars:
    delegated_dbhost: "{{ (zabbix_proxy_dbhost == 'localhost') | ternary(inventory_hostname, zabbix_proxy_dbhost) }}"
  tags:
    - database

- name: "MySQL | Create database and import file"
  community.mysql.mysql_db:
    login_host: "{{ zabbix_proxy_mysql_login_host | default(omit) }}"
    login_user: "{{ zabbix_proxy_mysql_login_user | default(omit) }}"
    login_password: "{{ zabbix_proxy_mysql_login_password | default(omit) }}"
    login_port: "{{ zabbix_proxy_mysql_login_port | default(omit) }}"
    login_unix_socket: "{{ zabbix_proxy_mysql_login_unix_socket | default(omit) }}"
    name: "{{ zabbix_proxy_dbname }}"
    encoding: "{{ zabbix_proxy_dbencoding }}"
    collation: "{{ zabbix_proxy_dbcollation }}"
    state: import
    target: "{{ ls_output_schema.stdout }}"
  when:
    - zabbix_proxy_database_sqlload
    - not done_file.stat.exists
  delegate_to: "{{ zabbix_proxy_real_dbhost | default(zabbix_proxy_dbhost_run_install | ternary(delegated_dbhost, inventory_hostname)) }}"
  vars:
    delegated_dbhost: "{{ (zabbix_proxy_dbhost == 'localhost') | ternary(inventory_hostname, zabbix_proxy_dbhost) }}"
  tags:
    - database

- name: "MySQL | Revert innodb_default_row_format to previous value"
  community.mysql.mysql_variables:
    variable: innodb_default_row_format
    value: "{{ mysql_innodb_default_row_format.msg }}"
    login_host: "{{ zabbix_proxy_mysql_login_host | default(omit) }}"
    login_user: "{{ zabbix_proxy_mysql_login_user | default(omit) }}"
    login_password: "{{ zabbix_proxy_mysql_login_password | default(omit) }}"
    login_port: "{{ zabbix_proxy_mysql_login_port | default(omit) }}"
    login_unix_socket: "{{ zabbix_proxy_mysql_login_unix_socket | default(omit) }}"
  when:
    - zabbix_proxy_database_sqlload | bool
    - not done_file.stat.exists
    - mysql_innodb_default_row_format.msg != 'dynamic'
  delegate_to: "{{ zabbix_proxy_real_dbhost | default(zabbix_proxy_dbhost_run_install | ternary(delegated_dbhost, inventory_hostname)) }}"
  vars:
    delegated_dbhost: "{{ (zabbix_proxy_dbhost == 'localhost') | ternary(inventory_hostname, zabbix_proxy_dbhost) }}"
  tags:
    - database

- name: "MySQL | Create done file"
  ansible.builtin.file:
    path: /etc/zabbix/schema.done
    state: touch
    mode: "0644"
  become: true
  when:
    - zabbix_proxy_database_sqlload
    - not done_file.stat.exists
  tags:
    - database
