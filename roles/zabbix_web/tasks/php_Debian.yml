---

- include_tasks: apache.yml
  when:
    - zabbix_websrv == 'apache'

# This obviously needs to have some improvements.. :)

- name: "Debian | Determine php prefix for packages installations (legacy php5)"
  set_fact:
    _zabbix_php_package_prefix: 5
  when:
    - ansible_distribution == 'Ubuntu' and ansible_distribution_version is version_compare('16.04', '<')
      or ansible_distribution == 'Debian' and ansible_distribution_version is version_compare('9', '<')

- name: "Debian | Determine php prefix for packages installations (Current distros)"
  set_fact:
    _zabbix_php_package_prefix: "{{ zabbix_php_version }}"
  when:
    - ansible_distribution == 'Ubuntu' and ansible_distribution_version is version_compare('16.04', '>=') or
      ansible_distribution == 'Debian' and ansible_distribution_version is version_compare('9', '>=')
    - zabbix_version is version_compare('5.0', '>=')
    - not _zabbix_web_apache_php_addition

- name: "Debian | Install php packages"
  apt:
    state: present
    update_cache: true
    cache_valid_time: 3600
    name:
      - php{{ _zabbix_php_package_prefix }}-{{ zabbix_server_database }}
      - php{{ _zabbix_php_package_prefix }}-bcmath
      - php{{ _zabbix_php_package_prefix }}-mbstring
      - php{{ _zabbix_php_package_prefix }}-ldap
      - php{{ _zabbix_php_package_prefix }}-xml
      - php{{ _zabbix_php_package_prefix }}-gd
      - php{{ _zabbix_php_package_prefix }}-fpm
  register: zabbix_web_php_dependency_install
  until: zabbix_web_php_dependency_install is succeeded
  become: true
  tags:
    - zabbix-web
    - init
