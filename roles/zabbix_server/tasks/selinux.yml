---
- name: "SELinux | Install related SELinux packages"
  ansible.builtin.package:
    name:
      - checkpolicy
      - policycoreutils
      - python3-libsemanage
      - python3-policycoreutils
      - zabbix-selinux-policy
  environment:
    http_proxy: "{{ zabbix_http_proxy | default(None) | default(omit) }}"
    https_proxy: "{{ zabbix_https_proxy | default(None) | default(omit) }}"
  register: zabbix_server_dependencies_installed
  until: zabbix_server_dependencies_installed is succeeded
  become: true
  tags:
    - install

- name: "SELinux | Set booleans"
  ansible.posix.seboolean:
    name: "{{ item.name }}"
    state: "{{ item.state }}"
    persistent: true
  become: true
  tags:
    - config
  loop:
    - name: httpd_can_connect_zabbix
      state: "{{ selinux_allow_zabbix_can_http }}"
    - name: zabbix_can_network
      state: "{{ selinux_allow_zabbix_can_network }}"

#- name: "SELinux | RedHat | Add SEmodule to fix SELinux issue: zabbix_server_alerter.sock"
# ansible.builtin.script:
#    cmd: files/install_semodule.bsx
#  args:
#    creates: /etc/selinux/targeted/active/modules/400/zabbix_server_add/cil
#  become: true
#  tags:
#    - config

- when: ansible_facts['os_family'] == "RedHat"
  block:
    - name: Transfer zabbix selinux type enforcement file
      copy:
        src: files/zabbix_server_add.te
        dest: "{{ zabbix_zabbix_dir }}/zabbix_server_add.te"
        mode: 0444
      register: zabbix_selinux_module_file

    - name: Compile zabbix selinux module
      command: "checkmodule -M -m -o {{ zabbix_root_dir }}//zabbix_server_add.mod {{ zabbix_root_dir }}/zabbix_server_add.te"
      when: zabbix_selinux_module_file['changed']

    - name: Compile zabbix selinux policy package
      command: "semodule_package -o {{ zabbix_root_dir }}/zabbix_server_add.pp -m {{ zabbix_root_dir }}/zabbix_server_add.mod"
      when: zabbix_selinux_module_file['changed']

- become: true
  block:
    - name: Gather loaded SELinux modules
      command: semodule -l
      register: zabbix_selinux_modules_loaded
      when: ansible_facts['os_family'] == "RedHat"
      changed_when: false

    - name: Install selinux policy package
      command: "semodule -i {{ zabbix_root_dir }}/zabbix_server_add.pp"
      when:
        - ansible_facts['os_family'] == "RedHat"
        - ('ara-gunicorn' not in zabbix_selinux_modules_loaded['stdout_lines'] or zabbix_selinux_module_file['changed'])
