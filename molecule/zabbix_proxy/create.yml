---
- name: Create
  hosts: localhost
  connection: local

  gather_facts: false

  pre_tasks:
    - name: "Create network"
      community.docker.docker_network:
        name: zabbix

    - name: "Create MySQL Container"
      community.docker.docker_container:
        name: "{{ item.name }}-db"
        image: mysql:8.0
        state: started
        recreate: true
        networks:
          - name: zabbix
        env:
          MYSQL_ROOT_PASSWORD: changeme
      loop: "{{ molecule_yml.platforms }}"
      when:
        - '"mysql" in item.groups'

    - name: "Create postgresql Container"
      community.docker.docker_container:
        name: "{{ item.name }}-db"
        image: postgres:13
        state: started
        recreate: true
        networks:
          - name: zabbix
        env:
          POSTGRES_PASSWORD: changeme
      loop: "{{ molecule_yml.platforms }}"
      when:
        - '"pgsql" in item.groups'

  tasks:
    - name: "Create OS container"
      community.docker.docker_container:
        state: started
        recreate: true
        name: "{{ item.name }}"
        image: "{{ item.image }}"
        privileged: "{{ item.privileged | default(omit) }}"
        networks: "{{ item.networks | default(omit) }}"
        volumes: "{{ item.volumes | default(omit) }}"
        cgroupns_mode: "{{ item.cgroupns_mode | default(omit) }}"
      loop: "{{ molecule_yml.platforms }}"
