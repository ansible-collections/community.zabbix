---
- name: Prepare
  hosts: all

  tasks:
    # before anything else, put optional proxy configs in important parts of the os
    - name: "bash proxy"
      ansible.builtin.copy:
        content: |
          export HTTP_PROXY="{{ zabbix_http_proxy }}"
          export HTTPS_PROXY="{{ zabbix_https_proxy }}"
          export http_proxy="{{ zabbix_http_proxy }}"
          export https_proxy="{{ zabbix_https_proxy }}"
          export no_proxy="{{ zabbix_no_proxy }}"
          export NO_PROXY="{{ zabbix_no_proxy }}"
        dest: /etc/profile.d/proxy.sh
      when:
        - zabbix_http_proxy is defined
    - name: "apt proxy"
      ansible.builtin.copy:
        content: |
          Acquire::http::Proxy "{{ zabbix_http_proxy }}";
          Acquire::https::Proxy "{{ zabbix_https_proxy }}";
        dest: /etc/apt/apt.conf.d/99proxy
      when:
        - ansible_facts['os_family'] == 'Debian'
        - zabbix_http_proxy is defined
    - name: "dnf proxy"
      ansible.builtin.lineinfile:
        regexp: '^proxy='
        line: 'proxy={{ zabbix_http_proxy }}'
        path: /etc/dnf/dnf.conf
      when:
        - ansible_facts['os_family'] == 'RedHat'
        - zabbix_http_proxy is defined
    - name: "suse proxy"
      ansible.builtin.copy:
        content: |
          export HTTP_PROXY="{{ zabbix_http_proxy }}"
          export HTTPS_PROXY="{{ zabbix_https_proxy }}"
          export http_proxy="{{ zabbix_http_proxy }}"
          export https_proxy="{{ zabbix_https_proxy }}"
          export no_proxy="{{ zabbix_no_proxy }}"
          export NO_PROXY="{{ zabbix_no_proxy }}"
        dest: /etc/sysconfig/proxy
      when:
        - ansible_facts['os_family'] == 'Suse'
        - zabbix_http_proxy is defined

    # To prevent services from starting during package installations on a docker build,
    # images normally come with this set to exit 101.
    - name: "Allow services to start on install"
      ansible.builtin.copy:
        content: |
          exit 0
        dest: /usr/sbin/policy-rc.d
      when: ansible_facts['os_family'] == 'Debian'

    - name: "Installing sudo"
      ansible.builtin.package:
        name:
          - sudo
        update_cache: "{{ (ansible_facts['os_family'] in ['Debian', 'Suse']) | ternary(true, omit) }}"
      register: installation_dependencies
      until: installation_dependencies is succeeded

    - name: "Configure SUDO."
      ansible.builtin.lineinfile:
        dest: /etc/sudoers
        line: "Defaults    !requiretty"
        state: present
