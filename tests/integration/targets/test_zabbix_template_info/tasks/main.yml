---
- name: "test - Prepare integration tests for zabbix_template_info module"
  zabbix_template:
    template_name: ExampleTemplateForTempleteInfoModule
    template_groups:
      - Templates
    state: present
  register: prepare_result

- assert:
    that:
      - prepare_result.changed is sameas true

- name: "test - Fetch template info as a JSON format from Zabbix Server"
  zabbix_template_info:
    template_name: ExampleTemplateForTempleteInfoModule
    format: json
  register: fetch_template_json_format_result

- name: "test - Set key to template_export_key variable(This deals with the key being masked)"
  set_fact:
    template_export_key: "{{ item }}"
  loop: "{{ fetch_template_json_format_result.template_json.keys() | list }}"
  when:
    - item | regex_search('_export')

- assert:
    that:
      - fetch_template_json_format_result.template_json[template_export_key].date is defined
      - fetch_template_json_format_result.template_json[template_export_key][template_groups_key].0.name == "Templates"
      - fetch_template_json_format_result.template_json[template_export_key].templates.0.name == "ExampleTemplateForTempleteInfoModule"
      - fetch_template_json_format_result.template_json[template_export_key].templates.0.template == "ExampleTemplateForTempleteInfoModule"

- name: "test - Fetch template info as a JSON format with omit_date parameter from Zabbix Server"
  zabbix_template_info:
    template_name: ExampleTemplateForTempleteInfoModule
    format: json
    omit_date: true
  register: fetch_template_json_format_omit_date_result

- assert:
    that:
      - fetch_template_json_format_omit_date_result.template_json[template_export_key].date is not defined
      - fetch_template_json_format_omit_date_result.template_json[template_export_key][template_groups_key].0.name == "Templates"
      - fetch_template_json_format_omit_date_result.template_json[template_export_key].templates.0.name == "ExampleTemplateForTempleteInfoModule"
      - fetch_template_json_format_omit_date_result.template_json[template_export_key].templates.0.template == "ExampleTemplateForTempleteInfoModule"

- name: "test - Fetch template info as a XML format from Zabbix Server"
  zabbix_template_info:
    template_name: ExampleTemplateForTempleteInfoModule
    format: xml
  register: fetch_template_xml_format_result

- assert:
    that:
      - fetch_template_xml_format_result.template_xml | regex_search('<date>.*</date>') is defined
      - fetch_template_xml_format_result.template_xml | regex_search('</date><groups><group><name>Templates</name></group></groups><templates>') is defined
      - fetch_template_xml_format_result.template_xml | regex_search('<templates><template><template>ExampleTemplateForTempleteInfoModule</template><name>ExampleTemplateForTempleteInfoModule</name><groups><group><name>Templates</name></group></groups></template></templates>') is defined

- name: "test - Fetch template info as a XML format with omit_date parameter from Zabbix Server"
  zabbix_template_info:
    template_name: ExampleTemplateForTempleteInfoModule
    format: xml
    omit_date: true
  register: fetch_template_xml_format_omit_date_result

- assert:
    that:
      - fetch_template_xml_format_omit_date_result.template_xml | regex_search('<date>.*</date>') is none
      - fetch_template_xml_format_omit_date_result.template_xml | regex_search('</date><groups><group><name>Templates</name></group></groups><templates>') is defined
      - fetch_template_xml_format_omit_date_result.template_xml | regex_search('<templates><template><template>ExampleTemplateForTempleteInfoModule</template><name>ExampleTemplateForTempleteInfoModule</name><groups><group><name>Templates</name></group></groups></template></templates>') is defined

- name: "test - Fetch template info as a YAML format from Zabbix Server"
  zabbix_template_info:
    template_name: ExampleTemplateForTempleteInfoModule
    format: yaml
  register: fetch_template_yaml_format_result
  when: zabbix_version is version('5.2', '>=')

- assert:
    that:
      - fetch_template_yaml_format_result.template_yaml | regex_search('date: .+') is defined
      - fetch_template_yaml_format_result.template_yaml | regex_search('name: Templates') is defined
      - fetch_template_yaml_format_result.template_yaml | regex_search('template: ExampleTemplateForTempleteInfoModule') is defined
  when: zabbix_version is version('5.2', '>=')

- name: "test - Fetch template info as a YAML format with omit_date parameter from Zabbix Server"
  zabbix_template_info:
    template_name: ExampleTemplateForTempleteInfoModule
    format: yaml
    omit_date: true
  register: fetch_template_yaml_format_omit_date_result
  when: zabbix_version is version('5.2', '>=')

- assert:
    that:
      - fetch_template_yaml_format_result.template_yaml | regex_search('date: .+') is not defined
      - fetch_template_yaml_format_result.template_yaml | regex_search('name: Templates') is defined
      - fetch_template_yaml_format_result.template_yaml | regex_search('template: ExampleTemplateForTempleteInfoModule') is defined
  when: zabbix_version is version('5.2', '>=')

- name: "test - Fetch template info with none format from Zabbix Server"
  zabbix_template_info:
    template_name: ExampleTemplateForTempleteInfoModule
    format: none
  register: fetch_template_none_format_result

- assert:
    that:
      - fetch_template_none_format_result.template_id is defined
      - fetch_template_none_format_result.template_json is not defined
      - fetch_template_none_format_result.template_xml is not defined
      - fetch_template_none_format_result.template_yaml is not defined
